# v2 Onboarding Implementation Plan

## Overview

Connect `goals.tsx` â†’ `generating.tsx` to enable real plan generation with dynamic progress feedback during onboarding.

## Files to Modify

| File                                             | Purpose                                            |
| ------------------------------------------------ | -------------------------------------------------- |
| `apps/native/app/onboarding/goals.tsx`           | Add missing inputs, pass data to generating screen |
| `apps/native/app/onboarding/generating.tsx`      | Real plan generation with dynamic progress         |
| `packages/db/src/queries/monthly-resolutions.ts` | Add missing `getResolutionsWithProgress` function  |

---

## Step 1: Update `goals.tsx`

**Location:** `apps/native/app/onboarding/goals.tsx`

### 1.1 Add State Variables

```typescript
const [taskComplexity, setTaskComplexity] = useState<"Simple" | "Balanced" | "Ambitious">("Balanced");
const [weekendPreference, setWeekendPreference] = useState<"Work" | "Rest" | "Mixed">("Mixed");
```

### 1.2 Add UI Sections

Add two new sections after the AI Companion section, before the FAB:

- **Task Complexity**: 3-card selector (Simple, Balanced, Ambitious)
- **Weekend Preference**: 3-chip selector (Work, Rest, Mixed)

### 1.3 Add Helper Function

```typescript
const getFocusAreas = (resolutions: Resolution[]) => {
  const categories = resolutions.map(r => r.category);
  const unique = [...new Set(categories)];
  return unique.join(",") || "personal";
};
```

### 1.4 Update `handleNext`

```typescript
const handleNext = () => {
  if (mainGoal.trim()) {
    router.push({
      pathname: "/onboarding/generating",
      params: {
        mainGoal,
        resolutions: JSON.stringify(resolutions),
        coachName,
        coachTone,
        taskComplexity,
        weekendPreference,
        focusAreas: getFocusAreas(resolutions),
      },
    });
  }
};
```

---

## Step 2: Update `generating.tsx`

**Location:** `apps/native/app/onboarding/generating.tsx`

### 2.1 Add Imports

```typescript
import { useLocalSearchParams } from "expo-router";
import { useMutation } from "@tanstack/react-query";
```

### 2.2 Update State

```typescript
const [currentStep, setCurrentStep] = useState(0);
const [isComplete, setIsComplete] = useState(false);
const [error, setError] = useState<string | null>(null);
```

### 2.3 Update Step Labels

```typescript
const STEPS = [
  { id: 0, label: "Saving your resolutions..." },
  { id: 1, label: "Configuring your AI companion..." },
  { id: 2, label: "Generating your monthly plan..." },
  { id: 3, label: "Finalizing your Zen plan..." },
];
```

### 2.4 Read Params

```typescript
const params = useLocalSearchParams();
const mainGoal = params.mainGoal as string;
const resolutions = params.resolutions ? JSON.parse(params.resolutions as string) : [];
const coachName = params.coachName as string;
const coachTone = params.coachTone as "encouraging" | "direct" | "analytical" | "friendly";
const taskComplexity = params.taskComplexity as "Simple" | "Balanced" | "Ambitious";
const weekendPreference = params.weekendPreference as "Work" | "Rest" | "Mixed";
const focusAreas = (params.focusAreas as string) || "personal";
```

### 2.5 Replace `useEffect` with Plan Generation Mutation

```typescript
const generatePlanMutation = useMutation({
  mutationFn: async () => {
    setError(null);
    setCurrentStep(0);

    // Step 1: Save yearly resolutions
    if (resolutions.length > 0) {
      await orpc.resolutions.createBatch.mutate({
        resolutions: resolutions.map(r => ({
          text: r.title,
          category: r.category,
          resolutionType: "yearly" as const,
          priority: 2,
        })),
      });
    }

    // Step 2: Save AI companion & preferences
    setCurrentStep(1);
    await orpc.preferences.update.mutate({
      coachName,
      coachTone,
      goalsText: mainGoal,
      taskComplexity,
      weekendPreference,
      focusAreas,
    });

    // Step 3: Generate monthly plan
    setCurrentStep(2);
    await orpc.plan.generate.mutate({
      goalsText: mainGoal,
      taskComplexity,
      focusAreas,
      weekendPreference,
      fixedCommitmentsJson: { commitments: [] },
    });

    // Step 4: Complete
    setCurrentStep(3);
  },
  onSuccess: () => {
    setIsComplete(true);
  },
  onError: (err: Error) => {
    setError(err.message);
  },
});

useEffect(() => {
  generatePlanMutation.mutate();
}, []);
```

### 2.6 Update UI Text

```typescript
<Text className="text-lg font-sans text-muted-foreground text-center leading-7 px-4 min-h-[60px]">
  {isComplete
    ? "Everything is set. Your path to clarity and focus starts now."
    : STEPS[currentStep]?.label || "Preparing..."}
</Text>
```

### 2.7 Add Error State with Retry Button

```typescript
{error && (
  <Animated.View entering={FadeInDown}>
    <Card className="p-6 bg-danger/10 border-danger/30">
      <Text className="text-base font-sans text-danger mb-4 text-center">
        {error}
      </Text>
      <Button
        size="lg"
        className="h-14 rounded-xl"
        onPress={() => generatePlanMutation.mutate()}
      >
        <Text className="text-lg font-sans-semibold text-danger-foreground">Try Again</Text>
      </Button>
    </Card>
  </Animated.View>
)}
```

---

## Step 3: Fix Missing `getResolutionsWithProgress`

**Location:** `packages/db/src/queries/monthly-resolutions.ts`

Add the missing function that `hybrid-plan-generation.ts` calls:

```typescript
export async function getResolutionsWithProgress(userId: string, year: number) {
  const currentYear = year || new Date().getFullYear();
  const resolutions = await getYearlyResolutions(userId, currentYear);

  return Promise.all(
    resolutions.map(async (r) => ({
      ...r,
      progressPercent: await calculateResolutionProgress(r.id),
    }))
  );
}
```

---

## Generation Sequence

| Step | API Call                                | Description                     |
| ---- | --------------------------------------- | ------------------------------- |
| 0    | `orpc.resolutions.createBatch.mutate()` | Save yearly resolutions         |
| 1    | `orpc.preferences.update.mutate()`      | Save AI companion & preferences |
| 2    | `orpc.plan.generate.mutate()`           | Generate monthly plan           |
| 3    | Complete                                | Show success state              |

---

## Type Safety

| Field               | Type                                                      |
| ------------------- | --------------------------------------------------------- |
| `coachTone`         | `"encouraging" \| "direct" \| "analytical" \| "friendly"` |
| `taskComplexity`    | `"Simple" \| "Balanced" \| "Ambitious"`                   |
| `weekendPreference` | `"Work" \| "Rest" \| "Mixed"`                             |
| `resolutions`       | `JSON.parse(params.resolutions as string)`                |

---

## Animation Timing

- Steps advance immediately after each API call completes (not fixed timer)
- Each step shows a label describing what's happening
- Total time = sum of actual API call durations (typically 5-15s)
- Error state shows retry button without leaving screen
